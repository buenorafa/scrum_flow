{% extends 'base.html' %}

{% block title %}Kanban - {{ user_story.title }} - Scrum Flow{% endblock %}

{% block extra_css %}
<style>
  .kanban-board {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }

  .kanban-column {
    flex: 1;
    min-width: 300px;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
  }

  .kanban-column-header {
    font-weight: bold;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
  }

  .kanban-task {
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    cursor: move;
    transition: all 0.2s;
  }

  .kanban-task:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transform: translateY(-2px);
  }

  .kanban-task.dragging {
    opacity: 0.5;
  }

  .kanban-column.drag-over {
    background-color: #e9ecef;
  }

  .task-priority-high {
    border-left: 4px solid #ffc107;
  }

  .task-priority-medium {
    border-left: 4px solid #0dcaf0;
  }

  .task-priority-low {
    border-left: 4px solid #6c757d;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  {% csrf_token %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'project_list' %}">Projetos</a></li>
      <li class="breadcrumb-item"><a href="{% url 'project_detail' project.pk %}">{{ project.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'user_story_detail' user_story.pk %}">{{ user_story.title|truncatewords:5 }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Kanban</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3><i class="bi bi-kanban"></i> Kanban Board</h3>
      <p class="text-muted mb-0">{{ user_story.title }}</p>
    </div>
    <div>
      <a href="{% url 'task_create' user_story.pk %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nova Task
      </a>
      <a href="{% url 'user_story_detail' user_story.pk %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>
  </div>

  <div class="kanban-board">
    <!-- TODO Column -->
    <div class="kanban-column" data-status="TODO">
      <div class="kanban-column-header text-secondary">
        <i class="bi bi-circle"></i> A Fazer
        <span class="badge bg-secondary">{{ tasks_todo.count }}</span>
      </div>
      {% for task in tasks_todo %}
        <div class="kanban-task task-priority-{{ task.priority|lower }}" draggable="true" data-task-id="{{ task.pk }}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0">
              <a href="{% url 'task_detail' task.pk %}" class="text-decoration-none text-dark">
                {{ task.title }}
              </a>
            </h6>
            {% if task.priority == 'HIGH' %}
              <span class="badge bg-warning text-dark">Alta</span>
            {% elif task.priority == 'MEDIUM' %}
              <span class="badge bg-info">Média</span>
            {% else %}
              <span class="badge bg-secondary">Baixa</span>
            {% endif %}
          </div>
          {% if task.description %}
            <p class="small text-muted mb-2">{{ task.description|truncatewords:10 }}</p>
          {% endif %}
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if task.assigned_to %}
                <i class="bi bi-person"></i> {{ task.assigned_to.username }}
              {% else %}
                <i class="bi bi-person-x"></i> Não atribuído
              {% endif %}
            </small>
            {% if task.estimated_hours %}
              <small class="text-muted">
                <i class="bi bi-clock"></i> {{ task.estimated_hours }}h
              </small>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center"><em>Nenhuma task</em></p>
      {% endfor %}
    </div>

    <!-- IN PROGRESS Column -->
    <div class="kanban-column" data-status="IN_PROGRESS">
      <div class="kanban-column-header text-primary">
        <i class="bi bi-arrow-repeat"></i> Em Progresso
        <span class="badge bg-primary">{{ tasks_in_progress.count }}</span>
      </div>
      {% for task in tasks_in_progress %}
        <div class="kanban-task task-priority-{{ task.priority|lower }}" draggable="true" data-task-id="{{ task.pk }}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0">
              <a href="{% url 'task_detail' task.pk %}" class="text-decoration-none text-dark">
                {{ task.title }}
              </a>
            </h6>
            {% if task.priority == 'HIGH' %}
              <span class="badge bg-warning text-dark">Alta</span>
            {% elif task.priority == 'MEDIUM' %}
              <span class="badge bg-info">Média</span>
            {% else %}
              <span class="badge bg-secondary">Baixa</span>
            {% endif %}
          </div>
          {% if task.description %}
            <p class="small text-muted mb-2">{{ task.description|truncatewords:10 }}</p>
          {% endif %}
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if task.assigned_to %}
                <i class="bi bi-person"></i> {{ task.assigned_to.username }}
              {% else %}
                <i class="bi bi-person-x"></i> Não atribuído
              {% endif %}
            </small>
            {% if task.estimated_hours %}
              <small class="text-muted">
                <i class="bi bi-clock"></i> {{ task.estimated_hours }}h
              </small>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center"><em>Nenhuma task</em></p>
      {% endfor %}
    </div>

    <!-- DONE Column -->
    <div class="kanban-column" data-status="DONE">
      <div class="kanban-column-header text-success">
        <i class="bi bi-check-circle"></i> Concluído
        <span class="badge bg-success">{{ tasks_done.count }}</span>
      </div>
      {% for task in tasks_done %}
        <div class="kanban-task task-priority-{{ task.priority|lower }}" draggable="true" data-task-id="{{ task.pk }}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0">
              <a href="{% url 'task_detail' task.pk %}" class="text-decoration-none text-dark">
                {{ task.title }}
              </a>
            </h6>
            {% if task.priority == 'HIGH' %}
              <span class="badge bg-warning text-dark">Alta</span>
            {% elif task.priority == 'MEDIUM' %}
              <span class="badge bg-info">Média</span>
            {% else %}
              <span class="badge bg-secondary">Baixa</span>
            {% endif %}
          </div>
          {% if task.description %}
            <p class="small text-muted mb-2">{{ task.description|truncatewords:10 }}</p>
          {% endif %}
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              {% if task.assigned_to %}
                <i class="bi bi-person"></i> {{ task.assigned_to.username }}
              {% else %}
                <i class="bi bi-person-x"></i> Não atribuído
              {% endif %}
            </small>
            {% if task.estimated_hours %}
              <small class="text-muted">
                <i class="bi bi-clock"></i> {{ task.estimated_hours }}h
              </small>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center"><em>Nenhuma task</em></p>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tasks = document.querySelectorAll('.kanban-task');
  const columns = document.querySelectorAll('.kanban-column');

  // Drag start
  tasks.forEach(task => {
    task.addEventListener('dragstart', function(e) {
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.taskId);
    });

    task.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      columns.forEach(col => col.classList.remove('drag-over'));
    });
  });

  // Drag over columns
  columns.forEach(column => {
    column.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.classList.add('drag-over');
    });

    column.addEventListener('dragleave', function() {
      this.classList.remove('drag-over');
    });

    column.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      const taskId = e.dataTransfer.getData('text/plain');
      const newStatus = this.dataset.status;
      
      // Update task status via AJAX
      updateTaskStatus(taskId, newStatus);
    });
  });

  function updateTaskStatus(taskId, newStatus) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/tasks/${taskId}/update-status/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
      },
      body: `status=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Reload page to update columns
        location.reload();
      } else {
        alert('Erro ao atualizar status da task');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erro ao atualizar status da task');
    });
  }
});
</script>
{% endblock %}
